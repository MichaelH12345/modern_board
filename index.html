<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Departures</title>
<style>
  @font-face {
    font-family: 'Open Sans Bold';
    src: url('https://raw.githubusercontent.com/MichaelH12345/simple-departure-board/main/Open%20Sans%20Bold.ttf') format('truetype');
  }
  @font-face {
    font-family: 'Open Sans';
    src: url('https://raw.githubusercontent.com/MichaelH12345/simple-departure-board/main/Open%20Sans%20Regular.ttf') format('truetype');
  }
 
  body {
    margin: 0;
    background-color: black;
    color: white;
    font-family: 'Open Sans', sans-serif;
    overflow: hidden;
  }
  header {
    background-color: #001f4d;
    border-bottom: 4px solid white;
    padding-left: 15px;
  }
  .header-title {
    font-family: 'Open Sans Bold';
    font-size: 4rem;
    margin: 0;
  }
  .header-row {
    display: flex;
    align-items: center;
    font-size: 2.5rem;
  }
.time { width: 100px; }
.destination { flex: 1; margin-left: 50px; }
.platform-header { width: 150px; position: absolute; right: 275px; text-align: right; }
.status { width: 150px; position: absolute; right: 15px; text-align: right; }

  .departure-row {
    display: flex;
    align-items: flex-start;
    font-size: 3rem;
    border-bottom: 3px solid grey;
    padding: 5px 15px;
    position: relative;
    line-height: 1.3;
    transition: transform 0.6s ease-in-out;
  }
  .slide-out {
    transform: translateX(100%);
  }
  .slide-in {
    transform: translateX(-100%);
    animation: slideIn 0.6s forwards ease-in-out;
  }
  @keyframes slideIn {
    from { transform: translateX(-100%); }
    to { transform: translateX(0); }
  }
  .destination-box { flex: 1; margin-left: 25px; }
  .secondary-info { font-size: 3rem; }
  .platform { position: absolute; right: 275px; }
  .expected { position: absolute; right: 15px; }

  .placeholder {
    height: 0;
    overflow: hidden;
    transition: height 0.5s ease-in-out;
  }

  footer {
    position: fixed;
    bottom: 0;
    width: 100%;
    height: 87.5px;
    background-color: #001f4d;
    border-top: 4px solid white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 15px;
    box-sizing: border-box;
  }
  #footer-message {
    font-size: 2.5rem;
    max-width: 75%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  #footer-page { font-size: 3rem; }
  #footer-time { font-size: 3.5rem; font-family: 'Open Sans Bold'; }
  #footer-time .label { font-size: 60%; font-family: 'Open Sans'; }

  @keyframes fade {
    0% { opacity: 0; }
    50% { opacity: 1; }
    100% { opacity: 0; }
  }
</style>
</head>
<body>
  <header>
    <div class="header-title" id="header-title">Station Departures</div>
    <div class="header-row">
      <div class="time">Time</div>
      <div class="destination">Destination</div>
      <div class="platform-header">Plat</div>
      <div class="status">Status</div>
    </div>
  </header>
  <div id="departures-container"></div>
  <footer>
    <div id="footer-message"></div>
    <div id="footer-page"></div>
    <div id="footer-time">
      <span class="label">Time now </span>
      <span id="footer-time-value"></span>
    </div>
  </footer>

<script>
const container = document.getElementById('departures-container');
const footerMessage = document.getElementById('footer-message');
const footerTimeValue = document.getElementById('footer-time-value');
const headerTitle = document.getElementById('header-title');

let currentStationCode = 'CAR';
let services = [];              // All current services from API, sorted by STD
let previousServices = [];      // For detecting changes
let visibleServices = [];       // Currently displayed services

function getServiceId(service) {
  return `${service.std}-${service.destination?.[0]?.locationName || ''}`;
}

function isTime(value) {
  return /^\d{2}:\d{2}$/.test(value);
}

function updateFooterTime() {
  const now = new Date();
  footerTimeValue.textContent = now.toLocaleTimeString('en-GB', { hour12: false });
}
setInterval(updateFooterTime, 1000);
updateFooterTime();

function updateFooterDate() {
  const now = new Date();
  const weekday = now.toLocaleDateString('en-GB', { weekday: 'long' });
  const day = now.getDate();
  const month = now.toLocaleDateString('en-GB', { month: 'long' });
  function getOrdinal(n) {
    if (n >= 11 && n <= 13) return n + 'th';
    switch (n % 10) {
      case 1: return n + 'st';
      case 2: return n + 'nd';
      case 3: return n + 'rd';
      default: return n + 'th';
    }
  }
  footerMessage.textContent = `${weekday} ${getOrdinal(day)} ${month}`;
}
updateFooterDate();

function fillRow(row, service) {
  row.innerHTML = '';
  const time = document.createElement('div');
  time.textContent = service.std || '';
  row.appendChild(time);

  const destBox = document.createElement('div');
  destBox.classList.add('destination-box');
  const destMain = document.createElement('div');
  destMain.textContent = service.destination?.[0]?.locationName || '';
  destBox.appendChild(destMain);

  if (service.destination?.[0]?.via) {
    const viaLine = document.createElement('div');
    viaLine.textContent = service.destination[0].via;
    viaLine.classList.add('secondary-info');
    destBox.appendChild(viaLine);
  }

  if (service.length && service.length !== 0) {
    const lengthLine = document.createElement('div');
    lengthLine.textContent = `This train has ${service.length} coaches.`;
    lengthLine.classList.add('secondary-info');
    destBox.appendChild(lengthLine);
  }

  if (service.cancelReason || service.delayReason) {
    const reasonLine = document.createElement('div');
    if (service.cancelReason) {
      reasonLine.textContent = service.cancelReason.replace('This service has been cancelled because of', 'Service cancelled due to') + '.';
    } else if (service.delayReason) {
      reasonLine.textContent = service.delayReason.replace('This service has been delayed by', 'Service delayed due to') + '.';
    }
    reasonLine.classList.add('secondary-info');
    destBox.appendChild(reasonLine);
  }

  row.appendChild(destBox);

  const platform = document.createElement('div');
  platform.classList.add('platform');
  platform.textContent = service.platform || '';
  row.appendChild(platform);

  const expected = document.createElement('div');
  expected.classList.add('expected');
  if (isTime(service.etd)) {
    expected.textContent = `Exp ${service.etd}`;
  } else {
    expected.textContent = service.etd || 'On time';
  }

  if (service.etd === 'Cancelled') {
    expected.style.animation = 'fade 2s infinite';
    expected.style.color = '#00bfff';
    expected.style.fontFamily = 'Open Sans Bold';
  } else if (service.etd && service.etd !== 'On time') {
    expected.style.color = '#00bfff';
    expected.style.fontFamily = 'Open Sans Bold';
  } else {
    expected.style.color = 'white';
    expected.style.animation = 'none';
    expected.style.fontFamily = 'Open Sans';
  }

  row.appendChild(expected);
}

function createRow(service) {
  const row = document.createElement('div');
  row.classList.add('departure-row');
  row.dataset.id = getServiceId(service);
  fillRow(row, service);
  return row;
}

// Add as many new services as fit on screen
async function addNextAvailableService() {
  const pageHeight = window.innerHeight - 175;
  let bottom = container.lastElementChild ? container.lastElementChild.getBoundingClientRect().bottom : 0;

  for (const service of services) {
    const id = getServiceId(service);
    if (visibleServices.some(s => getServiceId(s) === id)) continue;

    const testRow = createRow(service);
    testRow.style.visibility = 'hidden';
    container.appendChild(testRow);
    const fits = testRow.getBoundingClientRect().bottom < pageHeight;
    container.removeChild(testRow);

    if (!fits) break;

    const newRow = createRow(service);
    newRow.classList.add('slide-in');
    container.appendChild(newRow);
    visibleServices.push(service);
    setTimeout(() => newRow.classList.remove('slide-in'), 600);
  }
}

function removeRowWithStretch(row, index) {
  const height = row.offsetHeight;
  row.classList.add('slide-out');

  setTimeout(() => {
    if (row.parentNode) container.removeChild(row);

    const placeholder = document.createElement('div');
    placeholder.classList.add('placeholder');
    placeholder.style.height = `${height}px`;

    container.insertBefore(placeholder, container.children[index]);

    void placeholder.offsetHeight;
    placeholder.style.height = '0px';

    setTimeout(() => {
      if (placeholder.parentNode) container.removeChild(placeholder);
      addNextAvailableService();
    }, 500);
  }, 600);
}

async function fetchDepartures() {
  try {
    const res = await fetch(`https://huxley2.azurewebsites.net/departures/${currentStationCode}/25`);
    const data = await res.json();

    headerTitle.textContent = `${data.locationName || currentStationCode} Departures`;

    let newServices = data.trainServices || [];

    // Sort by STD
    newServices.sort((a, b) => {
      const t1 = (a.std || '99:99').split(':').map(Number);
      const t2 = (b.std || '99:99').split(':').map(Number);
      return (t1[0]*60 + t1[1]) - (t2[0]*60 + t2[1]);
    });

    // Remove duplicates
    const seen = new Set();
    newServices = newServices.filter(s => {
      const id = getServiceId(s);
      if (seen.has(id)) return false;
      seen.add(id);
      return true;
    });

    if (previousServices.length === 0) {
      services = newServices;
      previousServices = structuredClone(newServices);
      visibleServices = [];
      container.innerHTML = '';
      addNextAvailableService();
      return;
    }

    const currentRows = Array.from(container.querySelectorAll('.departure-row'));

    // Update rows where ETD/cancellation/delay changed
    newServices.forEach((service, i) => {
      const old = previousServices.find(p => getServiceId(p) === getServiceId(service));
      if (old) {
        const changed = service.etd !== old.etd ||
                        service.cancelReason !== old.cancelReason ||
                        service.delayReason !== old.delayReason;

        if (changed && currentRows[i]) {
          currentRows[i].classList.add('slide-out');
          setTimeout(() => {
            fillRow(currentRows[i], service);
            currentRows[i].classList.remove('slide-out');
            currentRows[i].classList.add('slide-in');
            setTimeout(() => currentRows[i].classList.remove('slide-in'), 600);
          }, 600);
        }
      }
    });

    // Remove services that have disappeared from the API
    const newIds = new Set(newServices.map(getServiceId));
    currentRows.forEach((row, index) => {
      const service = visibleServices[index];
      if (service && !newIds.has(getServiceId(service))) {
        removeRowWithStretch(row, index);
        // Update visibleServices to reflect removal
        visibleServices = visibleServices.filter(s => getServiceId(s) !== getServiceId(service));
      }
    });

    services = newServices;
    previousServices = structuredClone(newServices);

    // Add any new services if there's space
    setTimeout(addNextAvailableService, 100);

  } catch (err) {
    console.error(err);
    container.innerHTML = `<div style="text-align:center;font-size:3rem;margin-top:150px;">Error loading departures.</div>`;
  }
}

fetchDepartures();
setInterval(fetchDepartures, 10000);

window.addEventListener('resize', () => {
  container.innerHTML = '';
  visibleServices = [];
  addNextAvailableService();
});

headerTitle.addEventListener('click', () => {
  const code = prompt('Enter a station code (e.g., EUS, LST, GTW):', currentStationCode);
  if (code) {
    currentStationCode = code.toUpperCase();
    services = [];
    previousServices = [];
    visibleServices = [];
    container.innerHTML = '';
    fetchDepartures();
  }
});
</script>
</body>
</html>
