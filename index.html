<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Departures</title>

<style>
  @font-face {
    font-family: 'Open Sans Bold';
    src: url('https://raw.githubusercontent.com/MichaelH12345/simple-departure-board/main/Open%20Sans%20Bold.ttf') format('truetype');
  }
  @font-face {
    font-family: 'Open Sans';
    src: url('https://raw.githubusercontent.com/MichaelH12345/simple-departure-board/main/Open%20Sans.ttf') format('truetype');
  }

  body {
    margin: 0;
    background-color: black;
    color: white;
    font-family: 'Open Sans', sans-serif;
    overflow: hidden;
  }

  header {
    background-color: #001f4d;
    border-bottom: 4px solid white;
    padding-left: 15px;
  }

  .header-title {
    font-family: 'Open Sans Bold';
    font-size: 4rem;
    margin: 0;
  }

  .header-row {
    display: flex;
    align-items: center;
    font-size: 2.5rem;
  }

.time { 
  width: 100px; 
}

.destination { 
  flex: 1; 
  margin-left: 50px; 
}

.platform-header { 
  width: 150px; 
  position: absolute;
  right: 275px;
  text-align: right;
}

.status { 
  width: 150px; 
  position: absolute;
  right: 15px;
  text-align: right;
}


  .departure-row {
    display: flex;
    align-items: flex-start;
    font-size: 3rem;
    border-bottom: 3px solid grey;
    padding: 5px 15px;
    position: relative;
    line-height: 1.3;
    transition: transform 0.6s ease-in-out;
  }

  .slide-out {
    transform: translateX(100%);
  }

  .slide-in {
    transform: translateX(-100%);
    animation: slideIn 0.6s forwards ease-in-out;
  }

  @keyframes slideIn {
    from { transform: translateX(-100%); }
    to { transform: translateX(0); }
  }

  .destination-box { flex: 1; margin-left: 25px; }

  .secondary-info {
    font-size: 3rem;
  }

  .platform { position: absolute; right: 275px; }
  .expected { position: absolute; right: 15px; }

  footer {
    position: fixed;
    bottom: 0;
    width: 100%;
    height: 87.5px;
    background-color: #001f4d;
    border-top: 4px solid white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 15px;
    box-sizing: border-box;
  }

  #footer-message {
    font-size: 2.5rem;
    max-width: 75%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  #footer-page {
    font-size: 3rem;
  }

  #footer-time {
    font-size: 3.5rem;
    font-weight: bold;
  }

  #footer-time .label {
    font-size: 60%;
    font-weight: normal;
  }

  @keyframes fade {
    0% { opacity: 0; }
    50% { opacity: 1; }
    100% { opacity: 0; }
  }
</style>
</head>

<body>
  <header>
    <div class="header-title" id="header-title">Station Departures</div>
    <div class="header-row">
      <div class="time">Time</div>
      <div class="destination">Destination</div>
      <div class="platform-header">Plat</div>
      <div class="status">Status</div>
    </div>
  </header>

  <div id="departures-container"></div>

  <footer>
    <div id="footer-message"></div>
    <div id="footer-page"></div>
    <div id="footer-time">
      <span class="label">Time now </span>
      <span id="footer-time-value"></span>
    </div>
  </footer>

<script>
let etdHistory = {}; // key: serviceId, value: array of last 15 etd values

const container = document.getElementById('departures-container');
const footerMessage = document.getElementById('footer-message');
const footerTimeValue = document.getElementById('footer-time-value');
const headerTitle = document.getElementById('header-title');

let currentStationCode = 'CAR';
let services = [];
let previousServices = [];
let visibleServices = [];
let expiredServices = new Set();

function updateFooterTime() {
  const now = new Date();
  footerTimeValue.textContent = now.toLocaleTimeString('en-GB', { hour12: false });
}
setInterval(updateFooterTime, 1000);
updateFooterTime();

function updateFooterDate() {
  const now = new Date();
  const weekday = now.toLocaleDateString('en-GB', { weekday: 'long' });
  const day = now.getDate();
  const month = now.toLocaleDateString('en-GB', { month: 'long' });
  const year = now.getFullYear();
  footerMessage.textContent = `${weekday} ${day} ${month} ${year}`;
}
updateFooterDate();

// --- Helpers ---
function isTime(str) { return /^\d{2}:\d{2}$/.test(str); }
function timeToDate(timeStr) {
  const now = new Date();
  const [h, m] = timeStr.split(':').map(Number);
  return new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m, 0);
}

function fillRow(row, service) {
  row.innerHTML = '';
  const time = document.createElement('div'); time.textContent = service.std || ''; row.appendChild(time);

  const destBox = document.createElement('div'); destBox.classList.add('destination-box');
  const destMain = document.createElement('div'); destMain.textContent = service.destination?.[0]?.locationName || ''; destBox.appendChild(destMain);

  if (service.destination?.[0]?.via) { const viaLine = document.createElement('div'); viaLine.textContent = service.destination[0].via; viaLine.classList.add('secondary-info'); destBox.appendChild(viaLine); }
  if (service.length && service.length !== 0) { const lengthLine = document.createElement('div'); lengthLine.textContent = `This train has ${service.length} coaches.`; lengthLine.classList.add('secondary-info'); destBox.appendChild(lengthLine); }
  if (service.cancelReason || service.delayReason) { const reasonLine = document.createElement('div'); if (service.cancelReason) reasonLine.textContent = service.cancelReason.replace('This service has been cancelled because of','Service cancelled due to')+'.'; else reasonLine.textContent = service.delayReason.replace('This service has been delayed by','Service delayed due to')+'.'; reasonLine.classList.add('secondary-info'); destBox.appendChild(reasonLine); }

  row.appendChild(destBox);

  const platform = document.createElement('div'); platform.classList.add('platform'); platform.textContent = service.platform || ''; row.appendChild(platform);

  const expected = document.createElement('div'); expected.classList.add('expected');
  if (/^\d{2}:\d{2}$/.test(service.etd)) expected.textContent = `Exp ${service.etd}`; else expected.textContent = service.etd || 'On time';
  if (service.etd === 'Cancelled') { expected.style.animation = 'fade 2s infinite'; expected.style.color = '#00bfff'; expected.style.fontWeight = 'bold'; }
  else if (service.etd && service.etd !== 'On time') { expected.style.color = '#00bfff'; expected.style.fontWeight = 'bold'; }
  else { expected.style.color = 'white'; expected.style.animation = 'none'; }
  row.appendChild(expected);
}

// --- Create row helper ---
function createServiceRow(service) {
  const row = document.createElement('div'); row.classList.add('departure-row'); fillRow(row, service); return row;
}

// --- Slide-out & remove with container stretch ---
function removeService(id) {
  const index = visibleServices.findIndex(s => `${s.std}-${s.destination?.[0]?.locationName}` === id);
  if (index === -1) return;
  const row = container.children[index];
  if (!row) return;

  row.classList.add('slide-out');
  expiredServices.add(id);

  setTimeout(() => {
    const rowHeight = row.offsetHeight;
    if (row.parentNode) container.removeChild(row);

    // placeholder for container animation
    const placeholder = document.createElement('div');
    placeholder.style.height = `${rowHeight}px`;
    placeholder.style.transition = 'height 0.5s ease';
    placeholder.style.background = 'transparent';
    container.insertBefore(placeholder, container.children[index]);

    setTimeout(() => {
      placeholder.style.height = '0px';
      setTimeout(() => {
        if (placeholder.parentNode) container.removeChild(placeholder);

        // add next available service if space
        addNextAvailableService();
      }, 500);
    }, 50);

  }, 600);
}

// --- Check ETD stability for auto-remove ---
function checkServiceExpiry() {
  const now = new Date();
  for (let service of services) {
    const id = `${service.std}-${service.destination?.[0]?.locationName}`;
    if (expiredServices.has(id)) continue;

    if (!etdHistory[id]) etdHistory[id] = [];
    const history = etdHistory[id];
    history.push(service.etd);
    if (history.length > 15) history.shift();

    const stableOnTime = history.every(v => v === 'On time');
    const stableNumber = history.every(v => v === history[0] && isTime(v));

    const stdDate = timeToDate(service.std);
    const etdDate = isTime(service.etd) ? timeToDate(service.etd) : null;

    if (stableOnTime && now - stdDate > 30_000) removeService(id);
    else if (stableNumber && etdDate && now - etdDate > 30_000) removeService(id);
  }
}
setInterval(checkServiceExpiry, 1000);

// --- Render rows ---
function renderRows() {
  container.innerHTML = '';
  visibleServices = [];
  const pageHeight = window.innerHeight;
  const seen = new Set();
  for (let service of services) {
    const id = `${service.std}-${service.destination?.[0]?.locationName}`;
    if (expiredServices.has(id) || seen.has(id)) continue;
    seen.add(id);
    const row = createServiceRow(service);
    container.appendChild(row);
    const rowBottom = row.getBoundingClientRect().bottom;
    if (rowBottom > pageHeight - 75) { container.removeChild(row); break; }
    visibleServices.push(service);
  }
}

// --- Add next available service (fills space) ---
// --- Add as many new services as fit on screen (with slide-in animation) ---
async function addNextAvailableService() {
  try {
    const res = await fetch(`https://huxley2.azurewebsites.net/departures/${currentStationCode}`);
    const data = await res.json();
    const newServices = data.trainServices || [];

    const seenIds = new Set(visibleServices.map(s => `${s.std}-${s.destination?.[0]?.locationName}`));
    const availableServices = newServices.filter(s => {
      const id = `${s.std}-${s.destination?.[0]?.locationName}`;
      return !seenIds.has(id) && !expiredServices.has(id);
    });

    if (!availableServices.length) return;

    const pageHeight = window.innerHeight;
    const addedServices = [];

    for (let service of availableServices) {
      // Create a hidden temp row to measure height
      const tempRow = createServiceRow(service);
      tempRow.style.visibility = 'hidden';
      container.appendChild(tempRow);
      const newRowHeight = tempRow.getBoundingClientRect().height;
      container.removeChild(tempRow);

      const lastRowBottom = container.lastElementChild
        ? container.lastElementChild.getBoundingClientRect().bottom
        : 0;

      // Check if another service fits
      if (lastRowBottom + newRowHeight <= pageHeight - 75) {
        const newRow = createServiceRow(service);
        newRow.classList.add('slide-in');
        container.appendChild(newRow);
        visibleServices.push(service);
        addedServices.push(newRow);

        // Slight delay between multiple slide-ins for smoother effect
        await new Promise(res => setTimeout(res, 250));
      } else {
        break;
      }
    }

    // Remove the slide-in class after all animations are done
    setTimeout(() => {
      addedServices.forEach(r => r.classList.remove('slide-in'));
    }, 700);

  } catch (err) {
    console.error('Error fetching additional services:', err);
  }
}


// --- Fetch departures ---
async function fetchDepartures() {
  try {
    const res = await fetch(`https://huxley2.azurewebsites.net/departures/${currentStationCode}`);
    const data = await res.json();
    let newServices = data.trainServices || [];
    const stationName = data.locationName || currentStationCode;
    headerTitle.textContent = `${stationName} Departures`;

    newServices.sort((a,b)=>{
      const [h1,m1] = a.std.split(':').map(Number);
      const [h2,m2] = b.std.split(':').map(Number);
      return (h1*60+m1) - (h2*60+m2);
    });

    const seen = new Set();
    newServices = newServices.filter(s => {
      const id = `${s.std}-${s.destination?.[0]?.locationName}`;
      if (seen.has(id)) return false; seen.add(id); return true;
    });

    services = newServices;
    previousServices = JSON.parse(JSON.stringify(newServices));
    renderRows();

  } catch (err) { console.error(err); container.innerHTML = `<div style="text-align:center;font-size:3rem;margin-top:150px;">Error loading departures.</div>`; }
}

fetchDepartures();
setInterval(fetchDepartures, 10000);
window.addEventListener('resize', renderRows);

// --- Change station on header click ---
headerTitle.addEventListener('click', async () => {
  const code = prompt('Enter a station code (e.g., EUS, LST, GTW):', currentStationCode);
  if (code) {
    currentStationCode = code.toUpperCase();
    expiredServices.clear();
    previousServices = [];
    services = [];
    container.innerHTML = '';
    await fetchDepartures();
  }
});



</script>
</body>
</html>
