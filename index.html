<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Departures</title>

<style>
  @font-face {
    font-family: 'Open Sans Bold';
    src: url('https://raw.githubusercontent.com/MichaelH12345/simple-departure-board/main/Open%20Sans%20Bold.ttf') format('truetype');
  }
  @font-face {
    font-family: 'Open Sans';
    src: url('https://raw.githubusercontent.com/MichaelH12345/simple-departure-board/main/Open%20Sans%20Regular.ttf') format('truetype');
  }
  

  body {
    margin: 0;
    background-color: black;
    color: white;
    font-family: 'Open Sans', sans-serif;
    overflow: hidden;
  }

  header {
    background-color: #001f4d;
    border-bottom: 4px solid white;
    padding-left: 15px;
  }

  .header-title {
    font-family: 'Open Sans Bold';
    font-size: 4rem;
    margin: 0;
  }

  .header-row {
    display: flex;
    align-items: center;
    font-size: 2.5rem;
  }

.time { 
  width: 100px; 
}

.destination { 
  flex: 1; 
  margin-left: 50px; 
}

.platform-header { 
  width: 150px; 
  position: absolute;
  right: 275px;
  text-align: right;
}

.status { 
  width: 150px; 
  position: absolute;
  right: 15px;
  text-align: right;
}


  .departure-row {
    display: flex;
    align-items: flex-start;
    font-size: 3rem;
    border-bottom: 3px solid grey;
    padding: 5px 15px;
    position: relative;
    line-height: 1.3;
    transition: transform 0.6s ease-in-out;
  }

  .slide-out {
    transform: translateX(100%);
    animation: slideOut 0.5s forwards ease-in-out;
  }

.slide-in {
  transform: translateX(-100%);
  animation: slideIn 0.5s forwards ease-in-out;
}


  @keyframes slideIn {
    from { transform: translateX(-100%); }
    to { transform: translateX(0); }
  }

  .destination-box { flex: 1; margin-left: 25px; }

  .secondary-info {
    font-size: 3rem;
  }

  .platform { position: absolute; right: 275px; }
  .expected { position: absolute; right: 15px; }

  footer {
    position: fixed;
    bottom: 0;
    width: 100%;
    height: 87.5px;
    background-color: #001f4d;
    border-top: 4px solid white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 15px;
    box-sizing: border-box;
  }

  #footer-message {
    font-size: 2.5rem;
    max-width: 75%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  #footer-page {
    font-size: 3rem;
  }

  #footer-time {
    font-size: 3.5rem;
    font-family: 'Open Sans Bold';
  }

  #footer-time .label {
    font-size: 60%;
    font-family: 'Open Sans';
  }

  @keyframes fade {
    0% { opacity: 0; }
    50% { opacity: 1; }
    100% { opacity: 0; }
  }

@keyframes flashPlatform {
  0% { color: #000000; }
  50% { color: white; }
  100% { color: #000000; }
}

.platform-flash {
  animation: flashPlatform 2s infinite;
}
</style>
</head>

<body>
  <header>
    <div class="header-title" id="header-title">Station Departures</div>
    <div class="header-row">
      <div class="time">Time</div>
      <div class="destination">Destination</div>
      <div class="platform-header">Plat</div>
      <div class="status">Status</div>
    </div>
  </header>

  <div id="departures-container"></div>

  <footer>
    <div id="footer-message"></div>
    <div id="footer-page"></div>
    <div id="footer-time">
      <span class="label">Time now </span>
      <span id="footer-time-value"></span>
    </div>
  </footer>
<script>
const container = document.getElementById('departures-container');
const footerMessage = document.getElementById('footer-message');
const footerTimeValue = document.getElementById('footer-time-value');
const headerTitle = document.getElementById('header-title');

let currentStationCode = 'CAR';
let services = [];
let animatedServices = new Set();
let previousServices = [];
let previousServicesMap = {};
let visibleServices = [];
let expiredServices = new Set();
let etdHistory = {};
let etdCheckHistory = {}; // <-- Track last 5 ETDs for each service
const rows = Array.from(container.getElementsByClassName('departure-row'));
function isTime(value) {
  return /^\d{2}:\d{2}$/.test(value);
}

function createServiceRow(service) {
  const row = document.createElement('div');
  row.classList.add('departure-row');
  fillRow(row, service);
  return row;
}

function mapServices(services) {
  const map = {};
  services.forEach(s => {
    const id = `${s.std}-${s.destination?.[0]?.locationName}`;
    map[id] = {
      etd: s.etd,
      platform: s.platform,
      delayReason: s.delayReason,
      cancelReason: s.cancelReason
    };
  });
  return map;
}

function timeToDate(timeStr) {
  const now = new Date();
  const [hours, minutes] = timeStr.split(':').map(Number);
  return new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes, 0, 0);
}

function updateFooterTime() {
  const now = new Date();
  footerTimeValue.textContent = now.toLocaleTimeString('en-GB', { hour12: false });
}
setInterval(updateFooterTime, 1000);
updateFooterTime();

function updateFooterDate() {
  const now = new Date();
  const weekday = now.toLocaleDateString('en-GB', { weekday: 'long' });
  const day = now.getDate();
  const month = now.toLocaleDateString('en-GB', { month: 'long' });

  function getOrdinal(n) {
    if (n >= 11 && n <= 13) return n + 'th';
    switch (n % 10) {
      case 1: return n + 'st';
      case 2: return n + 'nd';
      case 3: return n + 'rd';
      default: return n + 'th';
    }
  }

  footerMessage.textContent = `${weekday} ${getOrdinal(day)} ${month}`;
}
updateFooterDate();

let flashStartTime = Date.now(); // global flash sync timestamp

function applyFlashing(element) {
  if (!element) return;

  element.classList.add('platform-flash');

  // Sync all flashing elements to the same animation start
  const elapsed = (Date.now() - flashStartTime) / 1000; // seconds
  element.style.animationDelay = `-${elapsed}s`;
}

function fillRow(row, service) {
  row.innerHTML = '';

  const time = document.createElement('div');
  time.textContent = service.std || '';
  row.appendChild(time);

  const destBox = document.createElement('div');
  destBox.classList.add('destination-box');
  const destMain = document.createElement('div');
  destMain.textContent = service.destination?.[0]?.locationName || '';
  destBox.appendChild(destMain);

  if (service.destination?.[0]?.via) {
    const viaLine = document.createElement('div');
    viaLine.textContent = service.destination[0].via;
    viaLine.classList.add('secondary-info');
    destBox.appendChild(viaLine);
  }

  if (service.length && service.length !== 0) {
    const lengthLine = document.createElement('div');
    lengthLine.textContent = `This train has ${service.length} coaches.`;
    lengthLine.classList.add('secondary-info');
    destBox.appendChild(lengthLine);
  }

  if (service.cancelReason || service.delayReason) {
    const reasonLine = document.createElement('div');
    if (service.cancelReason) {
      reasonLine.textContent = service.cancelReason.replace('This service has been cancelled because of', 'Service cancelled due to') + '.';
    } else if (service.delayReason) {
      reasonLine.textContent = service.delayReason.replace('This service has been delayed by', 'Service delayed due to') + '.';
    }
    reasonLine.classList.add('secondary-info');
    destBox.appendChild(reasonLine);
  }

  row.appendChild(destBox);

  const platform = document.createElement('div');
  platform.classList.add('platform');
  platform.textContent = service.platform || '';
  row.appendChild(platform);

  const expected = document.createElement('div');
  expected.classList.add('expected');

  // If etd equals std, treat as 'On time'
  let etdText = service.etd;
  if (service.etd === service.std) etdText = 'On time';

  if (/^\d{2}:\d{2}$/.test(etdText)) {
    expected.textContent = `Exp ${etdText}`;
  } else {
    expected.textContent = etdText || 'On time';
  }

  if (etdText === 'Cancelled') {
    expected.style.animation = 'fade 2s infinite';
    expected.style.color = '#00bfff';
    expected.style.fontFamily = 'Open Sans Bold';
  } else if (etdText && etdText !== 'On time') {
    expected.style.color = '#00bfff';
    expected.style.fontFamily = 'Open Sans Bold';
  } else {
    expected.style.color = 'white';
    expected.style.animation = 'none';
    expected.style.fontFamily = 'Open Sans';
  }

  row.appendChild(expected);
}

function updateServiceRow(row, newService) {
  const id = `${newService.std}-${newService.destination?.[0]?.locationName}`;
  const prev = previousServicesMap[id];
  if (!prev) return;

  // Normalize ETD
  const prevETD = (prev.etd === prev.std) ? 'On time' : prev.etd;
  const newETD = (newService.etd === newService.std) ? 'On time' : newService.etd;

  const platformChanged = prev.platform !== newService.platform;
  const changed = platformChanged || prevETD !== newETD || prev.delayReason !== newService.delayReason || prev.cancelReason !== newService.cancelReason;

  if (!changed) return;

  // Slide out current row
  row.classList.add('slide-out');

  setTimeout(() => {
    // Update row content
    fillRow(row, newService);

    // Make platform flash if changed or already flashing
    const platformDiv = row.querySelector('.platform');
    if (platformChanged || platformDiv.classList.contains('platform-flash')) {
      platformDiv.classList.add('platform-flash');
      applyFlashing(platformDiv);
    }

    // Slide row back in
    row.classList.remove('slide-out');
    row.classList.add('slide-in');
    setTimeout(() => row.classList.remove('slide-in'), 500);

  }, 500);
}






function renderRows() {
  container.innerHTML = '';
  visibleServices = [];

  const pageHeight = window.innerHeight;
  const seenIds = new Set();

  // Sort services by STD before rendering
  const sortedServices = services
    .filter(s => !expiredServices.has(`${s.std}-${s.destination?.[0]?.locationName}`))
    .sort((a, b) => {
      const [h1, m1] = a.std.split(':').map(Number);
      const [h2, m2] = b.std.split(':').map(Number);
      return (h1 * 60 + m1) - (h2 * 60 + m2);
    });

  for (let service of sortedServices) {
    const id = `${service.std}-${service.destination?.[0]?.locationName}`;
    if (seenIds.has(id)) continue;
    seenIds.add(id);

    const row = createServiceRow(service);
    container.appendChild(row);

    if (row.getBoundingClientRect().bottom > pageHeight - 75) {
      container.removeChild(row);
      break;
    }

    visibleServices.push(service);
  }
}

async function addNextAvailableService() {
  try {
    const res = await fetch(`https://huxley2.azurewebsites.net/departures/${currentStationCode}`);
    const data = await res.json();
    const newServices = data.trainServices || [];

    const seenIds = new Set(visibleServices.map(s => `${s.std}-${s.destination?.[0]?.locationName}`));
    const availableServices = newServices.filter(s => {
      const id = `${s.std}-${s.destination?.[0]?.locationName}`;
      return !seenIds.has(id) && !expiredServices.has(id);
    });

    if (availableServices.length === 0) return;

    const pageHeight = window.innerHeight;

    for (let service of availableServices) {
      const testRow = createServiceRow(service);
      testRow.style.visibility = 'hidden';
      container.appendChild(testRow);

      const fits = testRow.getBoundingClientRect().bottom < pageHeight - 75;
      container.removeChild(testRow);
      testRow.style.visibility = '';

      if (!fits) break;

      const newRow = createServiceRow(service);
      newRow.classList.add('slide-in');
      container.appendChild(newRow);
      visibleServices.push(service);
      seenIds.add(`${service.std}-${service.destination?.[0]?.locationName}`);
      setTimeout(() => newRow.classList.remove('slide-in'), 600);
    }
  } catch (err) {
    console.error('Error fetching additional service:', err);
  }
}


function expireService(id, index) {
  const row = container.children[index];
  if (!row) return;

  row.dataset.expiring = "true";
  expiredServices.add(id);

  const insertionIndex = [...container.children].indexOf(row);

  row.classList.add('slide-out');

  setTimeout(() => {
    let rowHeight = row.offsetHeight;

    if (row.parentNode) {
      container.removeChild(row);
    }

    if (!rowHeight || rowHeight < 20) rowHeight = 75;

    const placeholder = document.createElement('div');
    placeholder.style.height = `${rowHeight}px`;
    placeholder.style.transition = 'height 0.5s ease';
    placeholder.style.background = 'transparent';

    container.insertBefore(
      placeholder,
      container.children[insertionIndex] || null
    );

    setTimeout(() => {
      placeholder.style.height = '0px';
      setTimeout(() => {
        if (placeholder.parentNode) container.removeChild(placeholder);
        setTimeout(addNextAvailableService, 500);
      }, 500);
    }, 50);
  }, 600);
}

function checkExpiredServices() {
  const now = new Date();
  visibleServices.forEach((service, index) => {
    const id = `${service.std}-${service.destination?.[0]?.locationName}`;
    if (!etdCheckHistory[id]) etdCheckHistory[id] = [];
    etdCheckHistory[id].push(service.etd);
    if (etdCheckHistory[id].length > 10) etdCheckHistory[id].shift(); // track last 10 API calls

    const stdDate = timeToDate(service.std);
    const etdDate = isTime(service.etd) ? timeToDate(service.etd) : null;

    const last10Same = etdCheckHistory[id].length === 10 && etdCheckHistory[id].every(e => e === etdCheckHistory[id][0]);

    // Case 1: ETD is 'On time'
    if (last10Same && etdCheckHistory[id][0] === 'On time' && now - stdDate > 30000 && !expiredServices.has(id)) {
      expireService(id, index);
    }

    // Case 2: ETD is 'Delayed' or 'Cancelled' (do nothing here)
    // Case 3: ETD is something else (not 'On time', 'Delayed' or 'Cancelled')
    const etdText = etdCheckHistory[id][0];
    if (last10Same && etdText !== 'On time' && etdText !== 'Delayed' && etdText !== 'Cancelled' && etdDate && now - etdDate > 30000 && !expiredServices.has(id)) {
      expireService(id, index);
    }
  });
}


setInterval(checkExpiredServices, 1000);

function fetchDepartures() {
  fetch(`https://huxley2.azurewebsites.net/departures/${currentStationCode}`)
    .then(res => res.json())
    .then(data => {
      let newServices = data.trainServices || [];
      const stationName = data.locationName || currentStationCode;
      headerTitle.textContent = `${stationName} Departures`;

      // Remove duplicates by STD + destination
      const seen = new Set();
      newServices = newServices.filter(s => {
        const id = `${s.std}-${s.destination?.[0]?.locationName}`;
        if (seen.has(id)) return false;
        seen.add(id);
        return true;
      });

      // Sort by STD
      newServices.sort((a, b) => {
        const [h1, m1] = a.std.split(':').map(Number);
        const [h2, m2] = b.std.split(':').map(Number);
        return (h1 * 60 + m1) - (h2 * 60 + m2);
      });

      // Map previous services for updates
      previousServicesMap = mapServices(previousServices);

      // Update existing visible rows individually
      visibleServices.forEach((service, index) => {
        const row = container.children[index];
        if (!row) return;
        const id = `${service.std}-${service.destination?.[0]?.locationName}`;
        const updatedService = newServices.find(s => `${s.std}-${s.destination?.[0]?.locationName}` === id);
        if (updatedService) updateServiceRow(row, updatedService);
      });

      services = newServices;
      previousServices = JSON.parse(JSON.stringify(newServices));

      renderRows();
    })
    .catch(err => {
      console.error(err);
      container.innerHTML = `<div style="text-align:center;font-size:3rem;margin-top:150px;">Error loading departures.</div>`;
    });
}

fetchDepartures();
setInterval(fetchDepartures, 10000);
window.addEventListener('resize', renderRows);

headerTitle.addEventListener('click', async () => {
  const code = prompt('Enter a station code (e.g., EUS, LST, GTW):', currentStationCode);
  if (code) {
    currentStationCode = code.toUpperCase();
    expiredServices.clear();
    previousServices = [];
    services = [];
    container.innerHTML = '';
    await fetchDepartures();
  }
});
</script>



</body>
</html>
