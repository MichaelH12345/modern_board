<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Departures</title>
<style>
  @font-face {
    font-family: 'Open Sans Bold';
    src: url('https://raw.githubusercontent.com/MichaelH12345/simple-departure-board/main/Open%20Sans%20Bold.ttf') format('truetype');
  }
  @font-face {
    font-family: 'Open Sans';
    src: url('https://raw.githubusercontent.com/MichaelH12345/simple-departure-board/main/Open%20Sans%20Regular.ttf') format('truetype');
  }
  body {
    margin: 0;
    background-color: black;
    color: white;
    font-family: 'Open Sans', sans-serif;
    overflow: hidden;
  }
  header {
    background-color: #001f4d;
    border-bottom: 4px solid white;
    padding-left: 15px;
  }
  .header-title {
    font-family: 'Open Sans Bold';
    font-size: 4rem;
    margin: 0;
  }
  .header-row {
    display: flex;
    align-items: center;
    font-size: 2.5rem;
  }
  .time { width: 100px; }
  .destination { flex: 1; margin-left: 50px; }
  .platform-header { width: 150px; position: absolute; right: 285px; text-align: right; }
  .status { width: 150px; position: absolute; right: 15px; text-align: right; }
  .departure-row {
    display: flex;
    align-items: flex-start;
    font-size: 3rem;
    border-bottom: 3px solid grey;
    padding: 5px 15px;
    position: relative;
    line-height: 1.3;
    transition: transform 0.5s ease-in-out;
  }
  .slide-out {
    transform: translateX(100%);
  }
  .slide-in {
    transform: translateX(-100%);
    animation: slideIn 0.5s forwards ease-in-out;
  }
  @keyframes slideIn {
    from { transform: translateX(-100%); }
    to { transform: translateX(0); }
  }
  .destination-box { flex: 1; margin-left: 25px; }
  .secondary-info { font-size: 3rem; }
  .platform { position: absolute; right: 275px; }
  .expected { position: absolute; right: 15px; }
  .placeholder {
    height: 0;
    overflow: hidden;
    transition: height 0.5s ease-in-out;
  }
  footer {
    position: fixed;
    bottom: 0;
    width: 100%;
    height: 87.5px;
    background-color: #001f4d;
    border-top: 4px solid white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 15px;
    box-sizing: border-box;
  }
  #footer-message {
    font-size: 2.5rem;
    max-width: 75%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  #footer-page { font-size: 3rem; }
  #footer-time { font-size: 3.5rem; font-family: 'Open Sans Bold'; }
  #footer-time .label { font-size: 60%; font-family: 'Open Sans'; }

  @keyframes fade {
    0% { opacity: 0; }
    50% { opacity: 1; }
    100% { opacity: 0; }
  }

  .flash {
    animation: fade 1s infinite ease-in-out;
  }
</style>
</head>
<body>
  <header>
    <div class="header-title" id="header-title">Departures</div>
    <div class="header-row">
      <div class="time">Time</div>
      <div class="destination">Destination</div>
      <div class="platform-header">Platform</div>
      <div class="status">Status</div>
    </div>
  </header>
  <div id="departures-container"></div>
  <footer>
    <div id="footer-message"></div>
    <div id="footer-page"></div>
    <div id="footer-time">
      <span class="label">Time now </span>
      <span id="footer-time-value"></span>
    </div>
  </footer>

<script>
const container = document.getElementById('departures-container');
const footerMessage = document.getElementById('footer-message');
const footerTimeValue = document.getElementById('footer-time-value');
const headerTitle = document.getElementById('header-title');

let currentStationCode = 'CAR';
let services = [];           
let previousServices = [];   
let visibleServices = [];    
let lastFetchFailed = false;
let offlineStartTime = null;     
let failedAttemptCount = 0;      

const platformChangeTime = new Map();

function getServiceId(service) {
  return `${service.std}-${service.destination?.[0]?.locationName || ''}-${service.isBus ? 'bus' : 'train'}`;
}

function parseTime(std) {
  if (!std) return Infinity;
  const [h, m] = std.split(':').map(Number);
  return h * 60 + m;
}

function isTime(value) {
  return /^\d{2}:\d{2}$/.test(value);
}

function updateFooterTime() {
  const now = new Date();
  footerTimeValue.textContent = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
}
setInterval(updateFooterTime, 1000);
updateFooterTime();

function updateFooterDate() {
  const now = new Date();
  const weekday = now.toLocaleDateString('en-GB', { weekday: 'long' });
  const day = now.getDate();
  const month = now.toLocaleDateString('en-GB', { month: 'long' });
  function getOrdinal(n) {
    if (n >= 11 && n <= 13) return n + 'th';
    switch (n % 10) {
      case 1: return n + 'st';
      case 2: return n + 'nd';
      case 3: return n + 'rd';
      default: return n + 'th';
    }
  }
  footerMessage.textContent = `${weekday} ${getOrdinal(day)} ${month}`;
}
updateFooterDate();

function fillRow(row, service) {
  row.innerHTML = '';

  const time = document.createElement('div');
  time.textContent = service.std || '';
  row.appendChild(time);

  const destBox = document.createElement('div');
  destBox.classList.add('destination-box');
  const destMain = document.createElement('div');
  destMain.textContent = service.destination?.[0]?.locationName || '';
  destBox.appendChild(destMain);

  const operator = service.operator || '';
  const destName = service.destination?.[0]?.locationName || '';

  // Via
  if (service.destination?.[0]?.via) {
    const viaLine = document.createElement('div');
    viaLine.textContent = service.destination[0].via;
    viaLine.classList.add('secondary-info');
    destBox.appendChild(viaLine);
  }

  // Coach length
  if (service.length && service.length !== 0) {
    const lengthLine = document.createElement('div');
    lengthLine.textContent = `This train has ${service.length} coaches.`;
    lengthLine.classList.add('secondary-info');
    destBox.appendChild(lengthLine);
  }

    // Avanti Pendolino
  if (operator === 'Avanti West Coast') {
    const pendolinoLine = document.createElement('div');
    pendolinoLine.textContent = 'Avanti West Coast Pendolino';
    pendolinoLine.classList.add('secondary-info');
    destBox.appendChild(pendolinoLine);
  }

  // Heathrow Express — priority under Avanti Pendolino
  if (operator === 'Heathrow Express') {
    const heathrowLine = document.createElement('div');
    heathrowLine.textContent = 'Heathrow Express';
    heathrowLine.classList.add('secondary-info');
    destBox.appendChild(heathrowLine);
  }

  // LNER reservation message
  if (operator === 'London North Eastern Railway') {
    const lnerLine = document.createElement('div');
    lnerLine.textContent = 'Reserve seats up to 5 minutes before departure at LNER.co.uk';
    lnerLine.classList.add('secondary-info');
    destBox.appendChild(lnerLine);
  }


  // Delay/Cancel reason — always last, but doesn't block custom messages
  if (service.cancelReason || service.delayReason) {
    const reasonLine = document.createElement('div');
    if (service.cancelReason) {
      reasonLine.textContent = service.cancelReason.replace('This service has been cancelled because of', 'Service cancelled due to') + '.';
    } else if (service.delayReason) {
      reasonLine.textContent = service.delayReason.replace('This service has been delayed by', 'Service delayed due to') + '.';
    }
    reasonLine.classList.add('secondary-info');
    destBox.appendChild(reasonLine);
  }

  // Rail Replacement Bus — right after destination
  if (service.isBus) {
    const busLine = document.createElement('div');
    busLine.textContent = 'Rail Replacement Bus';
    busLine.classList.add('secondary-info');
    destBox.insertBefore(busLine, destBox.children[1]);
  }

  row.appendChild(destBox);

  const platform = document.createElement('div');
  platform.classList.add('platform');
  platform.textContent = service.platform || '';

  const id = getServiceId(service);
  const changeTime = platformChangeTime.get(id);
  const now = Date.now();
  const isFlashing = changeTime && (now - changeTime < 300000);

  if (isFlashing && service.platform) {
    platform.classList.add('flash');
    platform.style.fontFamily = 'Open Sans';
  } else {
    platform.classList.remove('flash');
    platform.style.fontFamily = 'Open Sans';
  }
  platform.style.color = 'white';
  row.appendChild(platform);

  const expected = document.createElement('div');
  expected.classList.add('expected');
  expected.textContent = isTime(service.etd) ? `Exp ${service.etd}` : (service.etd || 'On time');

  if (service.etd === 'Cancelled') {
    expected.classList.add('flash');
    expected.style.color = '#00bfff';
    expected.style.fontFamily = 'Open Sans Bold';
  } else if (service.etd && service.etd !== 'On time') {
    expected.classList.remove('flash');
    expected.style.color = '#00bfff';
    expected.style.fontFamily = 'Open Sans Bold';
  } else {
    expected.classList.remove('flash');
    expected.style.color = 'white';
    expected.style.fontFamily = 'Open Sans';
  }

  row.appendChild(expected);
}

function createRow(service) {
  const row = document.createElement('div');
  row.classList.add('departure-row');
  row.dataset.id = getServiceId(service);
  fillRow(row, service);
  return row;
}

function rebuildVisibleRows() {
  container.innerHTML = '';
  visibleServices = [];

  const availableHeight = window.innerHeight -
    document.querySelector('header').offsetHeight -
    document.querySelector('footer').offsetHeight - 5;

  for (const service of services) {
    const testRow = createRow(service);
    testRow.style.visibility = 'hidden';
    testRow.style.position = 'absolute';
    container.appendChild(testRow);

    if (testRow.getBoundingClientRect().bottom - container.getBoundingClientRect().top > availableHeight) {
      container.removeChild(testRow);
      break;
    }
    container.removeChild(testRow);

    const newRow = createRow(service);
    newRow.classList.add('slide-in');
    container.appendChild(newRow);
    visibleServices.push(service);
    setTimeout(() => newRow.classList.remove('slide-in'), 700);
  }
}

function addNewServicesIfPossible() {
  const availableHeight = window.innerHeight -
    document.querySelector('header').offsetHeight -
    document.querySelector('footer').offsetHeight - 20;

  for (const service of services) {
    const id = getServiceId(service);
    if (visibleServices.some(s => getServiceId(s) === id)) continue;

    const testRow = createRow(service);
    testRow.style.visibility = 'hidden';
    testRow.style.position = 'absolute';
    container.appendChild(testRow);

    const wouldFit = testRow.getBoundingClientRect().bottom - container.getBoundingClientRect().top <= availableHeight;
    container.removeChild(testRow);

    if (!wouldFit) break;

    const newRow = createRow(service);
    newRow.classList.add('slide-in');
    container.appendChild(newRow);
    visibleServices.push(service);
    setTimeout(() => newRow.classList.remove('slide-in'), 700);
  }
}

async function fetchDepartures() {
  let success = false;
  try {
    const res = await fetch(`https://huxley2.azurewebsites.net/departures/${currentStationCode}/25?accessToken=e48245fd-c8d4-46b5-87ef-60e71665e6b6`);
    const data = await res.json();

    headerTitle.textContent = `${data.locationName || currentStationCode} Departures`;

    let allServices = [];

    if (data.trainServices) {
      data.trainServices.forEach(s => {
        s.isBus = false;
        allServices.push(s);
      });
    }

    if (data.busServices) {
      data.busServices.forEach(s => {
        s.isBus = true;
        allServices.push(s);
      });
    }

    allServices.sort((a, b) => parseTime(a.std) - parseTime(b.std));

    const seen = new Set();
    const newServices = allServices.filter(s => {
      const id = getServiceId(s);
      if (seen.has(id)) return false;
      seen.add(id);
      return true;
    });

    success = true;
    failedAttemptCount = 0;
    offlineStartTime = null;

    if (lastFetchFailed) {
      services = newServices;
      previousServices = structuredClone(newServices);
      platformChangeTime.clear();
      rebuildVisibleRows();
      lastFetchFailed = false;
      return;
    }

    if (previousServices.length === 0) {
      services = newServices;
      previousServices = structuredClone(newServices);
      rebuildVisibleRows();
      return;
    }

    const currentRows = Array.from(container.querySelectorAll('.departure-row'));

    visibleServices.forEach((oldVisibleService, i) => {
      const newService = newServices.find(s => getServiceId(s) === getServiceId(oldVisibleService));
      if (!newService) return;

      const oldEtd = oldVisibleService.etd || 'On time';
      const newEtd = newService.etd || 'On time';

      const row = currentRows[i];

      if (oldVisibleService.platform !== newService.platform && newService.platform) {
        platformChangeTime.set(getServiceId(newService), Date.now());
      }

      if (newEtd !== oldEtd) {
        row.classList.add('slide-out');
        setTimeout(() => {
          fillRow(row, newService);
          row.classList.remove('slide-out');
          row.classList.add('slide-in');
          setTimeout(() => row.classList.remove('slide-in'), 700);
        }, 700);
      } else {
        fillRow(row, newService);
      }

      visibleServices[i] = newService;
    });

    const newIds = new Set(newServices.map(getServiceId));
    const rowsToRemove = [];
    currentRows.forEach((row, index) => {
      const service = visibleServices[index];
      if (service && !newIds.has(getServiceId(service))) {
        rowsToRemove.push({ row, index });
      }
    });

    if (rowsToRemove.length > 0) {
      rowsToRemove.reverse().forEach(({ row, index }) => {
        const height = row.offsetHeight;
        row.classList.add('slide-out');

        setTimeout(() => {
          if (row.parentNode) container.removeChild(row);
          visibleServices.splice(index, 1);

          const placeholder = document.createElement('div');
          placeholder.classList.add('placeholder');
          placeholder.style.height = `${height}px`;

          if (container.children[index]) {
            container.insertBefore(placeholder, container.children[index]);
          } else {
            container.appendChild(placeholder);
          }

          void placeholder.offsetHeight;
          placeholder.style.height = '0px';

          setTimeout(() => {
            if (placeholder.parentNode) container.removeChild(placeholder);

            if (!container.querySelector('.placeholder')) {
              setTimeout(() => {
                addNewServicesIfPossible();
              }, 500);
            }
          }, 550);
        }, 700);
      });
    } else {
      addNewServicesIfPossible();
    }

    services = newServices;
    previousServices = structuredClone(newServices);

  } catch (err) {
    console.error(err);

    failedAttemptCount++;

    if (!offlineStartTime) {
      offlineStartTime = Date.now();
    }

    const now = Date.now();
    const offlineMs = now - offlineStartTime;
    const offlineMins = Math.floor(offlineMs / 60000);
    const offlineSecs = Math.floor((offlineMs % 60000) / 1000);

    container.innerHTML = `
      <div style="text-align:center;font-size:3rem;margin-top:125px;">
        We're working to fix a fault with this board.<br><br>
        For live train information speak to station staff, use station help points<br>or check the National Rail app.<br>
        <br><br><br><br><br><br>
        <div style="font-size:0rem;">
          Time offline: ${offlineMins} mins ${offlineSecs} secs<br>
          Attempted API calls: ${failedAttemptCount}<br>
          Retrying in 10 seconds...
        </div>
      </div>`;

    lastFetchFailed = true;
  }
}

fetchDepartures();
setInterval(fetchDepartures, 10000);

window.addEventListener('resize', () => {
  rebuildVisibleRows();
});

headerTitle.addEventListener('click', () => {
  const code = prompt('Enter a station code (e.g., EUS, LST, GTW):', currentStationCode);
  if (code) {
    currentStationCode = code.toUpperCase();
    services = [];
    previousServices = [];
    visibleServices = [];
    platformChangeTime.clear();
    offlineStartTime = null;
    failedAttemptCount = 0;
    lastFetchFailed = false;
    container.innerHTML = '';
    fetchDepartures();
  }
});
</script>
</body>
</html>
